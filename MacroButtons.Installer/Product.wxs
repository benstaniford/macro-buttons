<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <?define ProductVersion="1.0.0.0" ?>
  <?define ProductName="MacroButtons" ?>
  <?define Manufacturer="MacroButtons" ?>
  <?define UpgradeCode="{A1B2C3D4-E5F6-7890-ABCD-EF1234567890}" ?>

  <Product Id="*"
           Name="$(var.ProductName)"
           Language="1033"
           Version="$(var.ProductVersion)"
           Manufacturer="$(var.Manufacturer)"
           UpgradeCode="$(var.UpgradeCode)">

    <Package InstallerVersion="200"
             Compressed="yes"
             InstallScope="perMachine"
             Description="$(var.ProductName) Installer"
             Comments="Touch-screen macro button panel with retro terminal aesthetic" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

    <MediaTemplate EmbedCab="yes" />

    <!-- Feature definition -->
    <Feature Id="ProductFeature" Title="MacroButtons" Level="1" Display="expand"
             Description="Core MacroButtons application files" AllowAdvertise="no" Absent="disallow">
      <ComponentGroupRef Id="PublishedDlls" />
      <ComponentRef Id="LicenseFile" />
      <ComponentRef Id="CopySamplesScript" />
      <ComponentGroupRef Id="SamplesReadme" />
      <ComponentGroupRef Id="AllSamplesInProgramFiles" />
      <ComponentRef Id="ApplicationShortcut" />
      <ComponentRef Id="UserProfileCleanup" />
    </Feature>

    <Feature Id="DesktopShortcutFeature" Title="Desktop Shortcut" Level="1"
             Description="Create a desktop shortcut for MacroButtons" AllowAdvertise="no">
      <ComponentRef Id="DesktopShortcut" />
    </Feature>

    <!-- Sample Profiles Feature - Optional copy to user profile -->
    <Feature Id="SamplesFeature" Title="Copy Sample Profiles to User Directory" Level="1000"
             Description="Copy all sample button profiles to %USERPROFILE%\.macrobuttons\ for immediate use. Includes samples for ComfyUI, Elite Dangerous, File Explorer, Firefox, Lightroom, Photoshop, Visual Studio, VS Code, Windows Calculator, Windows Desktop, and Windows Terminal. Sample reference files are always installed to Program Files. WARNING: This will overwrite any existing profiles with the same names." AllowAdvertise="no" />

    <!-- UI configuration -->
    <UIRef Id="WixUI_FeatureTree" />
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />

    <!-- Launch app after installation checkbox -->
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch MacroButtons" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" />

    <!-- Custom action to launch the application -->
    <CustomAction Id="LaunchApplication"
                  Directory="INSTALLFOLDER"
                  ExeCommand="[INSTALLFOLDER]MacroButtons.exe"
                  Execute="immediate"
                  Impersonate="yes"
                  Return="asyncNoWait" />

    <!-- Custom action to set data for deferred action (immediate) -->
    <CustomAction Id="SetCopySamplesData" Property="CopySamplesToUserProfile"
                  Value="[INSTALLFOLDER]"
                  Execute="immediate" />

    <!-- Custom action to copy selected samples to user profile (deferred) -->
    <CustomAction Id="CopySamplesToUserProfile"
                  Directory="TARGETDIR"
                  ExeCommand="cmd.exe /c powershell.exe -NoProfile -ExecutionPolicy Bypass -WindowStyle Hidden -File &quot;[CustomActionData]CopySamples.ps1&quot; -InstallFolder &quot;[CustomActionData]&quot;"
                  Execute="deferred"
                  Impersonate="yes"
                  Return="ignore" />

    <!-- Schedule the custom actions -->
    <InstallExecuteSequence>
      <Custom Action="SetCopySamplesData" Before="CopySamplesToUserProfile">
        NOT Installed AND &amp;SamplesFeature=3
      </Custom>
      <Custom Action="CopySamplesToUserProfile" After="InstallFiles">
        NOT Installed AND &amp;SamplesFeature=3
      </Custom>
      <Custom Action="LaunchApplication" After="InstallFinalize">
        NOT Installed AND NOT REMOVE AND WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1
      </Custom>
    </InstallExecuteSequence>

    <!-- Icon for Add/Remove Programs -->
    <Icon Id="icon.ico" SourceFile="MacroButtons.ico"/>
    <Property Id="ARPPRODUCTICON" Value="icon.ico" />
    <Property Id="ARPHELPLINK" Value="https://github.com/yourusername/macro-buttons" />
  </Product>

  <Fragment>
    <!-- Directory structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLFOLDER" Name="MacroButtons">
          <Directory Id="SAMPLESFOLDER" Name="samples" />
        </Directory>
      </Directory>
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="MacroButtons"/>
      </Directory>
      <Directory Id="DesktopFolder" Name="Desktop" />
      <!-- User profile directory for optional sample installation -->
      <Directory Id="UserProfileFolder">
        <Directory Id="USERPROFILEFOLDER" Name=".macrobuttons" />
      </Directory>
    </Directory>
  </Fragment>

  <Fragment>
    <!-- Clean up user profile folder on uninstall -->
    <DirectoryRef Id="USERPROFILEFOLDER">
      <Component Id="UserProfileCleanup" Guid="{3A334567-89AB-CDEF-0123-456789ABCDEF}">
        <RemoveFolder Id="RemoveUserProfileFolder" Directory="USERPROFILEFOLDER" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\MacroButtons" Name="UserProfileFolder" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </DirectoryRef>
  </Fragment>

  <Fragment>
    <!-- License file and PowerShell script (manually defined since they're not in the publish output) -->
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="LicenseFile" Guid="{F6A7B8C9-D0E1-2345-6789-012345678901}">
        <File Id="LicenseTxt"
              Source="$(var.ProjectDir)..\LICENSE"
              KeyPath="yes" />
      </Component>
      <Component Id="CopySamplesScript" Guid="{1C2D3E4F-5A6B-7C8D-9E0F-1A2B3C4D5E6F}">
        <File Id="CopySamplesPs1"
              Source="$(var.ProjectDir)CopySamples.ps1"
              KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <!-- Application files: Auto-generated by HarvestDlls target in DllsAuto.wxs -->
    <!-- Samples Files: Auto-generated by HarvestSamples target in SamplesAuto.wxs -->

    <!-- Start Menu Shortcut -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut" Guid="{F5A6B7C8-D9E0-1234-F123-456789012345}">
        <Shortcut Id="ApplicationStartMenuShortcut"
                  Name="MacroButtons"
                  Description="Touch-screen macro button panel"
                  Target="[INSTALLFOLDER]MacroButtons.exe"
                  WorkingDirectory="INSTALLFOLDER"/>
        <RemoveFolder Id="CleanUpShortCut" Directory="ApplicationProgramsFolder" On="uninstall"/>
        <RegistryValue Root="HKCU"
                       Key="Software\MacroButtons"
                       Name="installed"
                       Type="integer"
                       Value="1"
                       KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <!-- Desktop Shortcut -->
    <DirectoryRef Id="DesktopFolder">
      <Component Id="DesktopShortcut" Guid="{A6B7C8D9-E0F1-2345-1234-567890123456}">
        <Shortcut Id="DesktopShortcutId"
                  Name="MacroButtons"
                  Description="Touch-screen macro button panel"
                  Target="[INSTALLFOLDER]MacroButtons.exe"
                  WorkingDirectory="INSTALLFOLDER"/>
        <RegistryValue Root="HKCU"
                       Key="Software\MacroButtons"
                       Name="desktopShortcut"
                       Type="integer"
                       Value="1"
                       KeyPath="yes"/>
      </Component>
    </DirectoryRef>
  </Fragment>
</Wix>
